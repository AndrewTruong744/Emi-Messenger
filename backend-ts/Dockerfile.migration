FROM node:22.16-alpine

# Prisma 7 binaries on Alpine require these for the Query Engine
RUN apk add --no-cache openssl libc6-compat

WORKDIR /app

# Only copy what is strictly needed for the migration
COPY package*.json ./
COPY prisma ./prisma/
COPY src/prisma.config.ts ./src/

COPY global-bundle.pem ./

RUN npm ci --omit=dev && npm install prisma typescript tsx

RUN npx prisma generate

COPY migrate.sh ./
RUN chmod +x migrate.sh
